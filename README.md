# База данных компании "Город электронный"

## Структура БД

База данных размещена в 22 таблицах и выстроена следующим образом:

![Схема](images/schema.png)

[Ссылка][schema] на схему БД в приложении. [Реализация](dumps/city_electricity.sql) БД на MySQL.

Центральной таблицей является таблица users. Она содержит информацию о клиентах компании и её первичный ключ используется как индекс во многих других таблицах.

Похожей является таблица employees, в которой хранится информация о сотрудниках компании, а таблица work_posts хранит должности в компании. Связь типа многие-ко-многим между ними реализовывается через вспомогательную таблицу employees_posts.

Таблица balance_changes_log используется для хранения истории пополнения и списания средств с баланса каждого пользователя.

Таблицы-каталоги services, tariffs и devices хранят данные о услугах, тарифах и продаваемых устройствах соответственно. Таблицы movies и channels, хранящие списки фильмов и каналов, связаны с таблицей тарифов связью многие-ко-многим. У таблицы устройств также есть вспомогательные таблицы: device_models (конкретные хранимые на складах устройства), device_types (типы устройств), device_producers (производители устройств).

В свою очередь таблицы services_orders, tariffs_connections, devices_orders соотвествуют таблицам-каталогам. В них хранятся данные о покупках клиентами тех или иных услуг.

## Типовые данные

В файле [typical_data.sql](dumps/typical_data.sql) находятся типовые данные для каждой из таблиц. 

## Представления

### 1. Сотрудники
```sql
`v_employees` (
    ID,
    Фамилия,
    Имя,
    Отчество,
    Занимаемые должности,
    Дата и время приёма на работу,
    Дата и время увольнения
)
```

### 2. Оборудование
```sql
`v_devices` (
    ID,
    Название,
    Описание,
    Тип устройства,
    Название производителя,
    Цена,
    Дата и время добавления записи,
    Дата и время удаления записи
)
```

### 3. Модели устройств
```sql
`v_device_models` (
    ID,
    Серийный номер,
    Название устройства,
    Адрес склада,
    Дата и время продажи
)
```

### 4. Тарифы
```sql
`v_tariffs` (
    ID,
    Название,
    Описание,
    Скорость интернета,
    Количество каналов ТВ,
    Количество фильмов,
    Цена в месяц
)
```

## Процедуры 

### 1. `p_change_balance`
Изменение баланса пользователя и создание новой записи в таблице истории платежей `balance_changes_log`. Остальные процедуры также используют данную для учёта платежеё.

### 2. `p_order_devices`
Создание записи о заказе указанного количества устройств пользователем.

### 3. `p_delete_device_order`
Удаление заказа на устройства, если заказ ещё не выполнен.

### 4. `p_deliver_device`
Создание записи о доставке устройств и "закрытие" соответствующего заказа.

### 5. `p_connect_tariff`
Создание записи подключении тарифа пользователю на указанное количество месяцев.

### 6. `p_order_service`
Заказ услуги по указанному адресу в указанное время клиенту.

### 7. `p_delete_service_order`
Удаление заказа на оказание услуги по адресу, если она ещё не выполнена.

### 8. `p_execute_service`
Создание записи о выполнении услуги по адресу указанным сотрудником.

[schema]: https://www.dbdiagram.io/d/Gorod-elektronnyj-665ac6ecb65d9338793b1721
